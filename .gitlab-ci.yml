image: cirrusci/flutter:stable

stages:
  - analyze
  - build
  - test
  - deploy

build_linux:
  stage: build
  before_script: [sudo apt update && sudo apt install curl clang cmake ninja-build pkg-config libgtk-3-dev libblkid-dev liblzma-dev libsecret-1-dev libjsoncpp-dev libsqlite3-dev -y]
  script:
    - flutter config --enable-linux-desktop
    - flutter clean
    - flutter pub get
    - flutter packages pub run build_runner build
    - flutter build linux --release
  artifacts:
    when: on_success
    paths:
      - build/linux/release/bundle/
  tags:
    - shared

build_android:
  stage: build

  script:
    - flutter clean
    - flutter pub get
    - flutter packages pub run build_runner build
    - flutter build apk --release
  artifacts:
    when: on_success
    paths:
      - build/app/outputs/flutter-apk/app-release.apk
 
  only:
    - main # disable android 

  tags:
    - shared

build_web:
  image: cirrusci/flutter:beta # web is on beta...
  stage: build

  script:
    - flutter config --enable-web
    - flutter clean
    - flutter pub get
    - flutter packages pub run build_runner build
    - flutter build web --release

  artifacts:
    when: on_success
    paths:
      - build/web/

  tags:
    - shared

deploy_web:
  image: "debian:buster"
  stage: deploy
  
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - 'which rsync || ( apt-get update -y && apt-get install rsync -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -t rsa $HOST >> ~/.ssh/known_hosts
  script:
    - rsync -az build/web/ $USER@$HOST:app --delete
  only:
    - master

analyze:
  stage: analyze

  script:
    - flutter analyze
    - flutter format lib/ --set-exit-if-changed
    
  tags:
    - shared

#unit_test:
#  stage: test
#
#  script:
#    - flutter test test/*
#
#  tags:
#    - shared
